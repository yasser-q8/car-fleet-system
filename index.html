<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة أسطول السيارات - شركة نايف للأغذية</title>
    <link rel="icon" href="https://i.postimg.cc/NM2zJWZD/NAIF-LOGO.jpg">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary-red: #FF0000;
            --phosphorescent-green: #39FF14;
            --light-sky-blue: #87CEEB;
            --white: #FFFFFF;
            --dark-blue: #1E3A8A;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-sky-blue);
            color: #333;
            line-height: 1.6;
        }

        .container {
            width: 97%;
            max-width: 1350px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--primary-red);
            color: white;
            padding: 20px 0;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .company-logo-header {
            max-width: 60px;
            max-height: 60px;
            object-fit: contain;
            border-radius: 50%;
            border: 2px solid white;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: white;
        }

        .company-name-header {
            font-size: 16px;
            margin-top: 5px;
            color: white;
        }

        .nav-tabs {
            display: flex;
            background-color: var(--dark-blue);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .nav-tab {
            padding: 12px 20px;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
            text-align: center;
            flex: 1;
        }

        .nav-tab:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .nav-tab.active {
            background-color: var(--primary-red);
        }

        .content-section {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .content-section.active {
            display: block;
        }

        .section-title {
            color: var(--primary-red);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--phosphorescent-green);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }

        .data-table th {
            background-color: var(--dark-blue);
            color: white;
            cursor: pointer;
        }

        .data-table tr:hover {
            background-color: #f5f5f5;
        }

        .search-box {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }

        .search-box input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: var(--primary-red);
            color: white;
        }

        .btn-secondary {
            background-color: var(--phosphorescent-green);
            color: var(--dark-blue);
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--dark-blue);
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .alert-warning {
            background-color: #dc3545;
            color: white;
            border: 1px solid #c82333;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .compact-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 15px;
        }

        .compact-form-2 {
            display: grid;
            grid-template-columns: 1fr 1fr 2fr;
            gap: 15px;
        }

        .search-results {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: var(--phosphorescent-green);
            color: #333;
            position: absolute;
            width: 100%;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .search-result-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            transition: background-color 0.2s;
        }

        .search-result-item:hover {
            background-color: rgba(255,255,255,0.5);
        }

        .form-container {
            position: relative;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
            animation: float 3s ease-in-out infinite;
        }

        .stat-card.license {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
        }

        .stat-card.ad-license {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-red);
        }

        .error-message {
            color: #dc3545;
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close-modal {
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close-modal:hover {
            color: #000;
        }

        .company-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .company-logo {
            max-width: 100px;
            max-height: 60px;
            object-fit: contain;
        }

        .company-info {
            flex: 1;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            display: inline-block;
            padding: 10px 15px;
            background-color: var(--primary-red);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-input-label:hover {
            background-color: #cc0000;
        }

        /* توقيع المطور الجديد */
        .signature-card {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, #FF6E00, #2196F3);
            color: white;
            padding: 10.5px 17.5px;
            border-radius: 8.5px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1000;
            animation: float 6s ease-in-out infinite;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .signature-card:hover { 
            transform: scale(1.05); 
            box-shadow: 0 12px 35px rgba(0,0,0,0.4); 
        }

        @keyframes float { 
            0% { transform: translateY(0px); } 
            50% { transform: translateY(-15px); } 
            100% { transform: translateY(0px); } 
        }

        .signature-card::before {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(135deg, #80EF80, #2196F3);
            border-radius: 14px;
            z-index: -1;
            animation: borderGlow 3s linear infinite;
            background-size: 400%;
        }

        @keyframes borderGlow { 
            0% { background-position: 0% 50%; } 
            50% { background-position: 100% 50%; } 
            100% { background-position: 0% 50%; } 
        }

        .signature-card .name { 
            font-size: 0.95rem; 
            font-weight: 700; 
            margin-bottom: 5px; 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3); 
        }

        .signature-card .title { 
            font-size: 0.7rem; 
            opacity: 0.9; 
            font-weight: 500; 
        }

        @media (max-width: 768px) { 
            .signature-card { 
                position: relative; 
                bottom: auto; 
                left: auto; 
                margin: 20px auto 0; 
                width: fit-content; 
                animation: none; 
            } 
            .signature-card:hover { 
                transform: none; 
            } 
        }

        @media print {
            .signature-card {
                display: none;
            }
        }

        .alerts-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .alerts-table th, .alerts-table td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }
        
        .alerts-table th {
            background-color: var(--dark-blue);
            color: white;
        }
        
        .alerts-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .alerts-table tr:hover {
            background-color: #f1f1f1;
        }
        
        .days-remaining {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 15px;
            text-align: center;
        }
        
        .days-critical {
            background-color: #ffcccc;
            color: #cc0000;
        }
        
        .days-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .days-normal {
            background-color: #d4edda;
            color: #155724;
        }
        
        .days-expired {
            background-color: #ffcccc;
            color: #cc0000;
            font-weight: bold;
        }

        .receipt-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .receipt-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--primary-red);
            padding-bottom: 20px;
        }
        
        .receipt-logo {
            max-width: 120px;
            max-height: 80px;
            object-fit: contain;
            margin-bottom: 15px;
            border-radius: 50%;
            border: 2px solid var(--primary-red);
        }
        
        .receipt-title {
            color: var(--primary-red);
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .receipt-company {
            color: var(--dark-blue);
            font-size: 18px;
        }
        
        .receipt-details {
            margin-bottom: 30px;
        }
        
        .receipt-details h3 {
            color: var(--primary-red);
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .signature-container {
            margin-top: 30px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }
        
        .signature-box {
            width: 100%;
            height: 100px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
        }
        
        .signature-label {
            text-align: center;
            margin-top: 5px;
            font-weight: bold;
            color: #666;
        }
        
        .car-sketch-container {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background-color: #f9f9f9;
            overflow: visible;
        }
        
        .car-sketch {
            position: relative;
            width: 190px;
            height: 280px;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin: 0 auto 15px;
            overflow: hidden;
            border: 1px solid #dee2e6;
        }
        
        .car-body {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 100px;
            background-color: rgba(108, 117, 125, 0.1);
            border-radius: 10px;
            border: 1px solid #6c757d;
        }
        
        .car-front {
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            width: 20%;
            height: 80px;
            background-color: rgba(73, 80, 87, 0.1);
            border-radius: 5px 0 0 5px;
            border: 1px solid #495057;
        }
        
        .car-rear {
            position: absolute;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            width: 20%;
            height: 80px;
            background-color: rgba(73, 80, 87, 0.1);
            border-radius: 0 5px 5px 0;
            border: 1px solid #495057;
        }
        
        .car-window {
            position: absolute;
            top: 10px;
            left: 25%;
            width: 50%;
            height: 40px;
            background-color: rgba(160, 210, 255, 0.2);
            border-radius: 5px;
            border: 1px solid #a0d2ff;
        }
        
        .car-wheel {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: #343a40;
            border-radius: 50%;
        }
        
        .wheel-front {
            top: 85px;
            left: 20%;
        }
        
        .wheel-rear {
            top: 85px;
            right: 20%;
        }
        
        .car-direction {
            position: absolute;
            font-size: 12px;
            font-weight: bold;
            color: #333;
        }
        
        .front-direction {
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .rear-direction {
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .scratch-point {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #dc3545;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10;
        }
        
        .scratch-list {
            margin-top: 15px;
        }
        
        .scratch-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: white;
            border-radius: 5px;
            margin-bottom: 8px;
            border-left: 4px solid #dc3545;
        }
        
        .scratch-location {
            font-weight: bold;
        }
        
        .remove-scratch {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 3px 8px;
            cursor: pointer;
        }

        .alerts-bar {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .alerts-count {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .alert-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .alert-badge {
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .receipt-details .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .receipt-details .data-table th,
        .receipt-details .data-table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: right;
            width: 25%;
        }

        .receipt-details .data-table th {
            background-color: #f5f5f5;
            font-weight: bold;
            color: #333;
        }

        .receipt-details .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .receipt-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .receipt-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--primary-red);
            padding-bottom: 10px;
        }

        .receipt-header-text {
            flex: 1;
        }

        .receipt-table {
            font-size: 14px;
            margin-bottom: 15px;
        }

        .receipt-table th, 
        .receipt-table td {
            padding: 6px 8px;
            border: 1px solid #ddd;
        }

        .receipt-details {
            margin-bottom: 15px;
        }

        .car-sketch-container {
            margin-top: 10px;
            padding: 5px;
        }

        .signature-container {
            margin-top: 15px;
            padding-top: 10px;
        }

        /* قالب PDF المخفي */
        .pdf-template {
            position: fixed;
            left: -10000px;
            top: -10000px;
            width: 794px;
            height: 1123px;
            background: white;
            padding: 10px;
            box-sizing: border-box;
            z-index: -1000;
            font-size: 12px;
            font-family: 'Times New Roman', serif;
        }

        .pdf-header {
            padding: 5px;
            margin-bottom: 10px;
            padding-left: 30px;
        }

        .pdf-header-row {
            text-align: center;
        }

        .pdf-logo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--primary-red);
            margin: 0 auto 5px;
            display: block;
        }

        .pdf-title {
            color: var(--primary-red);
            margin: 0;
            font-size: 18px;
        }

        .statement-table {
            font-size: 10px;
            border-collapse: collapse;
            width: calc(100% - 40px);
            margin-left: 30px;
        }

        .statement-table th {
            padding: 4px;
            border: 1px solid #000;
            text-align: center;
            background: var(--primary-red);
            color: white;
        }

        .statement-table td {
            padding: 4px;
            border: 1px solid #000;
            text-align: center;
        }

        @media (max-width: 768px) {
            .receipt-details .data-table th,
            .receipt-details .data-table td {
                width: 50%;
                display: block;
            }
            
            .receipt-details .data-table tr {
                display: block;
                margin-bottom: 10px;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .logo-section {
                flex-direction: column;
                margin-bottom: 10px;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .compact-form, .compact-form-2 {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .car-sketch {
                width: 300px;
                height: 150px;
            }
            
            .alerts-bar {
                flex-direction: column;
                gap: 10px;
            }
            
            .alerts-count {
                justify-content: center;
            }
            
            .alert-badge {
                width: 30px;
                height: 30px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- توقيع المطور (التنسيق الجديد) -->
    <div class="signature-card">
        <div class="name">Yasser Elkhateeb</div>
        <div class="title">مطور البرنامج 67011143</div>
    </div>

    <!-- التطبيق الرئيسي -->
    <div id="appScreen">
        <div class="container">
            <header>
                <div class="header-content">
                    <div class="logo-section">
                        <img id="companyLogoHeader" src="https://i.postimg.cc/NM2zJWZD/NAIF-LOGO.jpg" alt="شعار الشركة" class="company-logo-header">
                        <div>
                            <div class="logo">نظام إدارة أسطول السيارات</div>
                            <div class="company-name-header">شركة نايف للأغذية</div>
                        </div>
                    </div>
                    <div class="user-info">
                        <span>مدير النظام</span>
                    </div>
                </div>
            </header>

            <div class="nav-tabs">
                <div class="nav-tab active" data-target="reports">التقارير والإحصائيات</div>
                <div class="nav-tab" data-target="alerts">التنبيهات</div>
                <div class="nav-tab" data-target="cars-data">بيانات السيارات</div>
                <div class="nav-tab" data-target="delivery-receipt">تسليم/استلام السيارات</div>
                <div class="nav-tab" data-target="car-history">كشف بيانات السيارة</div>
                <div class="nav-tab" data-target="settings">الإعدادات</div>
            </div>

            <!-- قسم التقارير والإحصائيات -->
            <section id="reports" class="content-section active">
                <h2 class="section-title">التقارير والإحصائيات</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>إجمالي السيارات</h4>
                        <p class="stat-number" id="totalCarsCount">0</p>
                    </div>
                    <div class="stat-card">
                        <h4>السيارات النشطة</h4>
                        <p class="stat-number" id="activeCarsCount">0</p>
                    </div>
                    <div class="stat-card">
                        <h4>السيارات تحت الصيانة</h4>
                        <p class="stat-number" id="maintenanceCarsCount">0</p>
                    </div>
                    <div class="stat-card license">
                        <h4>تراخيص السيارات المنتهية قريباً</h4>
                        <p class="stat-number" id="expiringLicensesCount">0</p>
                    </div>
                    <div class="stat-card ad-license">
                        <h4>تراخيص الإعلان المنتهية قريباً</h4>
                        <p class="stat-number" id="expiringAdLicensesCount">0</p>
                    </div>
                    <div class="stat-card">
                        <h4>عمليات التسليم النشطة</h4>
                        <p class="stat-number" id="activeDeliveriesCount">0</p>
                    </div>
                    <div class="stat-card">
                        <h4>إجمالي المواقع</h4>
                        <p class="stat-number" id="totalRestaurantsCount">0</p>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="monthlyReport">تقرير شهري</button>
                    <button class="btn btn-primary" id="yearlyReport">تقرير سنوي</button>
                    <button class="btn btn-primary" id="expiryReport">تقرير بالمواعيد المنتهية</button>
                    <button class="btn btn-secondary" id="exportReport">تصدير التقرير</button>
                </div>

                <div id="reportResults" style="margin-top: 20px;"></div>
            </section>

            <!-- قسم التنبيهات المفصلة -->
            <section id="alerts" class="content-section">
                <h2 class="section-title">التنبيهات</h2>
                
                <div id="licenseAlert" class="alert alert-warning" style="display: none;">
                    <strong>تنبيه:</strong> <span id="alertMessage"></span>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="refreshAlerts">تحديث التنبيهات</button>
                    <button class="btn btn-secondary" id="exportAlerts">تصدير التنبيهات</button>
                </div>
                
                <h3>التراخيص المنتهية</h3>
                <table class="alerts-table" id="expiringLicensesTable">
                    <thead>
                        <tr>
                            <th>رقم السيارة</th>
                            <th>نوع الترخيص</th>
                            <th>تاريخ الانتهاء</th>
                            <th>الأيام المتبقية</th>
                        </tr>
                    </thead>
                    <tbody id="expiringLicensesTableBody"></tbody>
                </table>
            </section>

            <!-- قسم بيانات السيارات -->
            <section id="cars-data" class="content-section">
                <h2 class="section-title">بيانات جميع السيارات</h2>
                
                <!-- شريط التنبيهات المختصر -->
                <div id="alertsBar" class="alerts-bar" style="display: none;">
                    <div class="alerts-count">
                        <div class="alert-item">
                            <span>تراخيص سيارات منتهية:</span>
                            <span class="alert-badge" id="licenseAlertCount">0</span>
                        </div>
                        <div class="alert-item">
                            <span>تراخيص إعلان منتهية:</span>
                            <span class="alert-badge" id="adLicenseAlertCount">0</span>
                        </div>
                        <div class="alert-item">
                            <span>تراخيص سيارات منتهية تماماً:</span>
                            <span class="alert-badge" id="expiredLicenseAlertCount">0</span>
                        </div>
                        <div class="alert-item">
                            <span>تراخيص إعلان منتهية تماماً:</span>
                            <span class="alert-badge" id="expiredAdLicenseAlertCount">0</span>
                        </div>
                    </div>
                    <button class="btn btn-warning" id="viewAlertsBtn">عرض التنبيهات التفصيلية</button>
                </div>
                
                <div class="action-buttons">
                    <label for="importCarsFile" class="file-input-label">استيراد بيانات من Excel</label>
                    <input type="file" id="importCarsFile" class="file-input" accept=".xlsx, .xls">
                    <button class="btn btn-primary" id="exportTemplate">تحميل نموذج تعبئة البيانات</button>
                    <button class="btn btn-primary" id="addNewCar">إضافة سيارة جديدة</button>
                </div>
                
                <div class="search-box">
                    <input type="text" id="carSearch" placeholder="ابحث برقم السيارة...">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="sortByLicense">ترتيب حسب انتهاء الترخيص</button>
                    <button class="btn btn-primary" id="sortByAdLicense">ترتيب حسب ترخيص الإعلان</button>
                    <button class="btn btn-primary" id="sortByMunicipalityLicense">ترتيب حسب ترخيص البلدية</button>
                    <button class="btn btn-secondary" id="printCarsTable">طباعة الجدول</button>
                    <button class="btn btn-secondary" id="exportCarsPDF">تصدير PDF</button>
                    <button class="btn btn-secondary" id="exportCarsExcel">تصدير Excel</button>
                </div>
                
                <table class="data-table" id="carsTable">
                    <thead>
                        <tr>
                            <th>رقم السيارة</th>
                            <th>نوع السيارة</th>
                            <th>موديل السيارة</th>
                            <th>سنة الصنع</th>
                            <th>تاريخ انتهاء دفتر السيارة</th>
                            <th>تاريخ انتهاء ترخيص الإعلان</th>
                            <th>تاريخ انتهاء ترخيص البلدية</th>
                            <th>الحالة</th>
                            <th class="no-export">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="carsTableBody"></tbody>
                </table>
            </section>

            <!-- قسم تسليم/استلام السيارات -->
            <section id="delivery-receipt" class="content-section">
                <h2 class="section-title">تسليم/استلام السيارات</h2>
                
                <div class="search-box">
                    <input type="text" id="deliverySearch" placeholder="ابحث برقم السيارة أو اسم السائق...">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="showDeliveryForm">تسجيل استلام/تسليم جديد</button>
                    <button class="btn btn-primary" id="showReceiptForm">نموذج استلام السيارة</button>
                    <button class="btn btn-secondary" id="printDelivery">طباعة</button>
                    <button class="btn btn-secondary" id="exportDeliveryPDF">تصدير PDF</button>
                    <button class="btn btn-secondary" id="exportDeliveryExcel">تصدير Excel</button>
                </div>
                
                <div id="deliveryForm" style="display: none; margin-bottom: 20px;">
                    <h3>نموذج تسليم/استلام السيارة</h3>
                    <div class="compact-form">
                        <div class="form-container">
                            <div class="form-group">
                                <label for="carNumber">رقم السيارة *</label>
                                <input type="text" id="carNumber" placeholder="ابحث واختر رقم السيارة">
                                <div class="error-message" id="carNumberError">يجب اختيار سيارة مسجلة</div>
                                <div class="search-results" id="carSearchResults"></div>
                            </div>
                        </div>
                        <div class="form-container">
                            <div class="form-group">
                                <label for="restaurantName">اسم الموقع *</label>
                                <input type="text" id="restaurantName" placeholder="ابحث واختر الموقع">
                                <div class="error-message" id="restaurantNameError">يجب اختيار موقع مسجل</div>
                                <div class="search-results" id="restaurantSearchResults"></div>
                            </div>
                        </div>
                        <div class="form-container">
                            <div class="form-group">
                                <label for="driverName">اسم السائق *</label>
                                <input type="text" id="driverName" placeholder="أدخل اسم السائق">
                            </div>
                        </div>
                        <div class="form-container">
                            <div class="form-group">
                                <label for="phoneNumber">رقم الموبايل</label>
                                <input type="text" id="phoneNumber" placeholder="أدخل رقم الموبايل">
                            </div>
                        </div>
                    </div>
                    <div class="compact-form-2">
                        <div class="form-group">
                            <label for="receiveDate">تاريخ الاستلام</label>
                            <input type="date" id="receiveDate">
                        </div>
                        <div class="form-group">
                            <label for="deliveryDate">تاريخ التسليم</label>
                            <input type="date" id="deliveryDate">
                        </div>
                        <div class="form-group">
                            <label for="notes">ملاحظات</label>
                            <textarea id="notes" rows="2" placeholder="أدخل أي ملاحظات على حالة السيارة"></textarea>
                        </div>
                    </div>
                    
                    <div class="car-sketch-container">
                        <h4>تحديد أماكن الخدوش بالسيارة</h4>
                        <div class="car-sketch" id="carSketch">
                            <div class="car-body"></div>
                            <div class="car-front"></div>
                            <div class="car-rear"></div>
                            <div class="car-window"></div>
                            <div class="car-wheel wheel-front"></div>
                            <div class="car-wheel wheel-rear"></div>
                            <div class="car-direction front-direction">أمام</div>
                            <div class="car-direction rear-direction">خلف</div>
                        </div>
                        <div class="scratch-list" id="scratchList"></div>
                        <button type="button" class="btn btn-secondary" id="clearScratches">مسح جميع الخدوش</button>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="saveDelivery">حفظ</button>
                        <button class="btn btn-secondary" id="cancelDelivery">إلغاء</button>
                    </div>
                </div>
                
                <!-- نموذج استلام السيارة مع التوقيع -->
                <div id="receiptForm" style="display: none; margin-bottom: 20px;">
                    <div class="receipt-container">
                        <div class="receipt-header">
                            <img id="receiptLogo" src="https://i.postimg.cc/NM2zJWZD/NAIF-LOGO.jpg" alt="شعار الشركة" class="receipt-logo">
                            <div class="receipt-header-text">
                                <h1 class="receipt-title">نموذج استلام سيارة</h1>
                                <div class="receipt-company">شركة نايف للأغذية</div>
                            </div>
                        </div>
                        <div class="receipt-details">
                            <h3>بيانات السيارة المستلمة</h3>
                            <table class="data-table receipt-table">
                                <tbody>
                                    <tr>
                                        <th>رقم السيارة</th>
                                        <td id="receiptCarNumber">-</td>
                                        <th>اسم الموقع</th>
                                        <td id="receiptRestaurant">-</td>
                                    </tr>
                                    <tr>
                                        <th>اسم السائق</th>
                                        <td id="receiptDriverName">-</td>
                                        <th>رقم الموبايل</th>
                                        <td id="receiptPhoneNumber">-</td>
                                    </tr>
                                    <tr>
                                        <th>تاريخ الاستلام</th>
                                        <td id="receiptReceiveDate">-</td>
                                        <th>ملاحظات</th>
                                        <td id="receiptNotes">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="car-sketch-container">
                            <h3>خريطة الخدوش بالسيارة</h3>
                            <div class="car-sketch" id="receiptCarSketch">
                                <div class="car-body"></div>
                                <div class="car-front"></div>
                                <div class="car-rear"></div>
                                <div class="car-window"></div>
                                <div class="car-wheel wheel-front"></div>
                                <div class="car-wheel wheel-rear"></div>
                                <div class="car-direction front-direction">أمام</div>
                                <div class="car-direction rear-direction">خلف</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <table class="data-table" id="deliveryTable">
                    <thead>
                        <tr>
                            <th>رقم السيارة</th>
                            <th>اسم السائق</th>
                            <th>رقم الموبايل</th>
                            <th>اسم الموقع</th>
                            <th>تاريخ الاستلام</th>
                            <th>تاريخ التسليم</th>
                            <th>ملاحظات</th>
                            <th class="no-export">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="deliveryTableBody"></tbody>
                </table>
            </section>

            <!-- قسم كشف بيانات السيارة -->
            <section id="car-history" class="content-section">
                <h2 class="section-title">كشف بيانات السيارة</h2>
                
                <div class="search-box">
                    <input type="text" id="carHistorySearch" placeholder="ابحث برقم السيارة، اسم السائق، أو الموديل...">
                    <div class="search-results" id="carHistorySearchResults"></div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" id="printHistory">طباعة الكشف</button>
                    <button class="btn btn-secondary" id="exportHistoryPDF">تصدير PDF</button>
                    <button class="btn btn-secondary" id="exportHistoryExcel">تصدير Excel</button>
                </div>
                
                <div id="carDetails"></div>
            </section>

            <!-- قسم الإعدادات (تم إزالة جميع الحقول) -->
            <section id="settings" class="content-section">
                <h2 class="section-title">الإعدادات</h2>
                
                <div class="action-buttons">
                    <label for="importRestaurantsFile" class="file-input-label">استيراد مواقع من Excel</label>
                    <input type="file" id="importRestaurantsFile" class="file-input" accept=".xlsx, .xls">
                    <button class="btn btn-primary" id="addRestaurant">إضافة موقع جديد</button>
                </div>
                
                <h3>إدارة المواقع</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>اسم الموقع</th>
                            <th class="no-export">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="restaurantsTableBody"></tbody>
                </table>
            </section>
        </div>
    </div>

    <!-- قالب PDF المخفي (لكشف السيارة) -->
    <div id="pdf-template" class="pdf-template">
        <div class="pdf-header">
            <div class="pdf-header-row">
                <div style="text-align: center; margin-bottom: 10px;">
                    <img src="https://i.postimg.cc/NM2zJWZD/NAIF-LOGO.jpg" alt="شعار الشركة" class="pdf-logo">
                    <h2 class="pdf-title">شركة نايف للأغذية</h2>
                </div>
                <h3 style="color: var(--primary-red); margin: 0 0 8px 0; font-size: 16px;">كشف بيانات السيارة</h3>
                <div style="margin-bottom: 8px; text-align: center;">
                    <div style="font-size: 14px; font-weight: bold; display: inline-block;">
                        رقم السيارة: <span id="pdf-car-number"></span>
                    </div>
                    <div style="display: inline-block; width: 1cm;"></div>
                    <div style="font-size: 12px; display: inline-block;">
                        تاريخ الطباعة: <span id="pdf-print-date"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="pdf-car-info" style="margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 11px; padding-left: 30px;"></div>
        
        <table class="statement-table" id="pdf-deliveries-table">
            <thead>
                <tr>
                    <th width="12%">تاريخ الاستلام</th>
                    <th width="12%">تاريخ التسليم</th>
                    <th width="15%">اسم السائق</th>
                    <th width="12%">رقم الموبايل</th>
                    <th width="15%">اسم الموقع</th>
                    <th width="34%">ملاحظات</th>
                </tr>
            </thead>
            <tbody id="pdf-table-body"></tbody>
        </table>
    </div>

    <!-- نموذج إضافة سيارة -->
    <div id="carModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeCarModal">&times;</span>
            <h2>إضافة سيارة جديدة</h2>
            <div class="form-group">
                <label for="newCarNumber">رقم السيارة *</label>
                <input type="text" id="newCarNumber" placeholder="أدخل رقم السيارة">
            </div>
            <div class="form-group">
                <label for="newCarType">نوع السيارة *</label>
                <input type="text" id="newCarType" placeholder="أدخل نوع السيارة">
            </div>
            <div class="form-group">
                <label for="newCarModel">موديل السيارة *</label>
                <input type="text" id="newCarModel" placeholder="أدخل موديل السيارة">
            </div>
            <div class="form-group">
                <label for="newCarYear">سنة الصنع *</label>
                <input type="number" id="newCarYear" placeholder="أدخل سنة الصنع">
            </div>
            <div class="form-group">
                <label for="newLicenseExpiry">تاريخ انتهاء دفتر السيارة *</label>
                <input type="date" id="newLicenseExpiry">
            </div>
            <div class="form-group">
                <label for="newAdLicenseExpiry">تاريخ انتهاء ترخيص الإعلان</label>
                <input type="date" id="newAdLicenseExpiry">
            </div>
            <div class="form-group">
                <label for="newMunicipalityLicenseExpiry">تاريخ انتهاء ترخيص البلدية</label>
                <input type="date" id="newMunicipalityLicenseExpiry">
            </div>
            <div class="form-group">
                <label for="newCarStatus">الحالة</label>
                <select id="newCarStatus">
                    <option value="نشطة">نشطة</option>
                    <option value="تحت الصيانة">تحت الصيانة</option>
                    <option value="غير نشطة">غير نشطة</option>
                </select>
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" id="saveCar">حفظ</button>
                <button class="btn btn-secondary" id="cancelCar">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- نموذج إضافة موقع (بدون نوع وعنوان) -->
    <div id="restaurantModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeRestaurantModal">&times;</span>
            <h2>إضافة موقع جديد</h2>
            <div class="form-group">
                <label for="newRestaurantName">اسم الموقع *</label>
                <input type="text" id="newRestaurantName" placeholder="أدخل اسم الموقع">
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" id="saveRestaurant">حفظ</button>
                <button class="btn btn-secondary" id="cancelRestaurant">إلغاء</button>
            </div>
        </div>
    </div>

    <script>
        // ========== بيانات السيارات الأولية ==========
        const initialCarsData = [
            { id: 1, number: '16/8826', type: 'تويوتا', model: '1994', year: 1994, licenseExpiry: '2026-03-10', adLicenseExpiry: '2026-06-17', municipalityLicenseExpiry: '2026-03-10', status: 'نشطة' },
            { id: 2, number: '8/5056', type: 'تويوتا', model: '1996', year: 1996, licenseExpiry: '2026-08-10', adLicenseExpiry: null, municipalityLicenseExpiry: null, status: 'نشطة' },
            { id: 3, number: '8/84638', type: 'تويوتا', model: '2003', year: 2003, licenseExpiry: '2026-11-12', adLicenseExpiry: '2026-04-16', municipalityLicenseExpiry: '2026-12-30', status: 'نشطة' },
            { id: 4, number: '3/37602', type: 'دايهاتسو', model: '2006', year: 2006, licenseExpiry: '2026-12-30', adLicenseExpiry: '2026-04-16', municipalityLicenseExpiry: '2026-12-08', status: 'نشطة' },
            { id: 5, number: '3/36017', type: 'دايهاتسو', model: '2008', year: 2008, licenseExpiry: '2026-04-04', adLicenseExpiry: '2026-04-16', municipalityLicenseExpiry: '2026-04-04', status: 'نشطة' },
            { id: 6, number: '2/28751', type: 'دايهاتسو', model: '2008', year: 2008, licenseExpiry: '2027-02-09', adLicenseExpiry: '2026-06-17', municipalityLicenseExpiry: '2027-02-15', status: 'نشطة' },
            { id: 7, number: '11/61043', type: 'ايسوزو', model: '2012', year: 2012, licenseExpiry: '2026-05-05', adLicenseExpiry: '2026-06-17', municipalityLicenseExpiry: '2026-05-04', status: 'نشطة' },
            { id: 8, number: '1/24469', type: 'ميتسوبيشى', model: '2014', year: 2014, licenseExpiry: '2026-05-03', adLicenseExpiry: '2026-06-17', municipalityLicenseExpiry: '2026-05-03', status: 'نشطة' },
            { id: 9, number: '1/15817', type: 'ميتسوبيشى', model: '2014', year: 2014, licenseExpiry: '2026-06-23', adLicenseExpiry: '2026-06-17', municipalityLicenseExpiry: '2026-05-27', status: 'نشطة' },
            { id: 10, number: '14/68978', type: 'ميتسوبيشى', model: '2015', year: 2015, licenseExpiry: '2026-05-10', adLicenseExpiry: '2026-10-12', municipalityLicenseExpiry: '2026-05-04', status: 'نشطة' },
            { id: 11, number: '14/46106', type: 'ميتسوبيشى', model: '2015', year: 2015, licenseExpiry: '2026-06-16', adLicenseExpiry: '2026-04-16', municipalityLicenseExpiry: '2026-05-27', status: 'نشطة' },
            { id: 12, number: '16/71355', type: 'فوسو', model: '2018', year: 2018, licenseExpiry: '2026-06-16', adLicenseExpiry: '2027-01-14', municipalityLicenseExpiry: '2026-05-27', status: 'نشطة' },
            { id: 13, number: '16/80272', type: 'فوسو', model: '2018', year: 2018, licenseExpiry: '2026-07-07', adLicenseExpiry: '2027-01-14', municipalityLicenseExpiry: '2026-07-07', status: 'نشطة' },
            { id: 14, number: '16/49198', type: 'ميتسوبيشى', model: '2019', year: 2019, licenseExpiry: '2026-06-18', adLicenseExpiry: '2027-01-14', municipalityLicenseExpiry: '2026-05-27', status: 'نشطة' },
            { id: 15, number: '16/34236', type: 'ميتسوبيشى', model: '2019', year: 2019, licenseExpiry: '2026-06-17', adLicenseExpiry: '2027-01-14', municipalityLicenseExpiry: '2026-06-03', status: 'نشطة' },
            { id: 16, number: '17/64559', type: 'ونيت تلاجة', model: '2020', year: 2020, licenseExpiry: '2026-06-09', adLicenseExpiry: '2027-01-14', municipalityLicenseExpiry: '2026-06-03', status: 'نشطة' },
            { id: 17, number: '21/12673', type: 'ايسوزو', model: '2021', year: 2021, licenseExpiry: '2026-11-13', adLicenseExpiry: '2027-01-14', municipalityLicenseExpiry: '2026-11-13', status: 'نشطة' },
            { id: 18, number: '21/11172', type: 'ايسوزو', model: '2021', year: 2021, licenseExpiry: '2026-10-23', adLicenseExpiry: null, municipalityLicenseExpiry: null, status: 'نشطة' },
            { id: 19, number: '22/38777', type: 'ايسوزو', model: '2023', year: 2023, licenseExpiry: '2026-12-24', adLicenseExpiry: '2026-10-12', municipalityLicenseExpiry: '2026-12-08', status: 'نشطة' },
            { id: 20, number: '22/38526', type: 'ايسوزو', model: '2023', year: 2023, licenseExpiry: '2026-12-24', adLicenseExpiry: '2026-10-12', municipalityLicenseExpiry: '2026-12-08', status: 'نشطة' },
            { id: 21, number: '22/67931', type: 'ايسوزو', model: '2024', year: 2024, licenseExpiry: '2026-07-01', adLicenseExpiry: '2026-10-12', municipalityLicenseExpiry: '2026-07-01', status: 'نشطة' },
            { id: 22, number: '22/67661', type: 'ايسوزو', model: '2024', year: 2024, licenseExpiry: '2026-07-01', adLicenseExpiry: '2026-10-12', municipalityLicenseExpiry: '2026-07-01', status: 'نشطة' },
            { id: 23, number: '11/41259', type: 'ميتسوبيشى', model: '2012', year: 2012, licenseExpiry: '2026-03-25', adLicenseExpiry: null, municipalityLicenseExpiry: null, status: 'نشطة' },
            { id: 24, number: '11/4789', type: 'ونيت', model: '1994', year: 1994, licenseExpiry: '2026-07-27', adLicenseExpiry: null, municipalityLicenseExpiry: null, status: 'نشطة' },
            { id: 25, number: '15/76528', type: 'ونيت', model: '2016', year: 2016, licenseExpiry: '2026-08-20', adLicenseExpiry: null, municipalityLicenseExpiry: null, status: 'نشطة' },
            { id: 26, number: '23/81493', type: 'توتوتا كوستر', model: '2025', year: 2025, licenseExpiry: '2028-01-20', adLicenseExpiry: null, municipalityLicenseExpiry: null, status: 'نشطة' },
            { id: 27, number: '23/81149', type: 'توتوتا كوستر', model: '2025', year: 2025, licenseExpiry: '2028-01-20', adLicenseExpiry: null, municipalityLicenseExpiry: null, status: 'نشطة' },
            { id: 28, number: '23/81274', type: 'توتوتا كوستر', model: '2025', year: 2025, licenseExpiry: '2028-01-20', adLicenseExpiry: null, municipalityLicenseExpiry: null, status: 'نشطة' },
            { id: 29, number: '14/32580', type: 'دايهاتسو', model: '2016', year: 2016, licenseExpiry: '2026-10-12', adLicenseExpiry: null, municipalityLicenseExpiry: null, status: 'نشطة' },
            { id: 30, number: '14/32981', type: 'دايهاتسو', model: '2016', year: 2016, licenseExpiry: '2026-10-12', adLicenseExpiry: null, municipalityLicenseExpiry: null, status: 'نشطة' },
            { id: 31, number: '14/11023', type: 'دايهاتسو', model: '2016', year: 2016, licenseExpiry: '2026-10-15', adLicenseExpiry: null, municipalityLicenseExpiry: null, status: 'نشطة' },
            { id: 32, number: '13/16479', type: 'دايهاتسو', model: '2016', year: 2016, licenseExpiry: '2026-11-29', adLicenseExpiry: null, municipalityLicenseExpiry: null, status: 'نشطة' },
            { id: 33, number: '22/29845', type: 'تويوتا', model: '2023', year: 2023, licenseExpiry: '2026-11-08', adLicenseExpiry: null, municipalityLicenseExpiry: null, status: 'نشطة' },
            { id: 34, number: '22/30275', type: 'تويوتا', model: '2023', year: 2023, licenseExpiry: '2026-01-08', adLicenseExpiry: null, municipalityLicenseExpiry: null, status: 'نشطة' }
        ];

        // ========== المواقع الثابتة ==========
        const initialRestaurantsData = [
            { id: 1, name: 'مخازن الشويخ الصناعية' },
            { id: 2, name: 'مخازن امغرة' },
            { id: 3, name: 'الادارة' }
        ];

        // ========== بيانات التطبيق ==========
        let carsData = JSON.parse(localStorage.getItem('carsData')) || initialCarsData;
        let deliveriesData = JSON.parse(localStorage.getItem('deliveriesData')) || [];
        let restaurantsData = JSON.parse(localStorage.getItem('restaurantsData')) || initialRestaurantsData;
        let currentSort = { field: 'licenseExpiry', order: 'asc' };
        let editingCarId = null;
        let editingDeliveryId = null;
        let editingRestaurantId = null;
        let scratches = [];

        // دالة لحفظ جميع البيانات
        function saveAllData() {
            try {
                localStorage.setItem('carsData', JSON.stringify(carsData));
                localStorage.setItem('deliveriesData', JSON.stringify(deliveriesData));
                localStorage.setItem('restaurantsData', JSON.stringify(restaurantsData));
                console.log('💾 تم حفظ جميع البيانات في التخزين المحلي');
            } catch (error) {
                console.error('❌ خطأ في حفظ البيانات:', error);
            }
        }

        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            setupEventListeners();
            loadAllData();
            checkLicenseExpiry();
            initializeCarSketch();
        }

        function setupEventListeners() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', switchTab);
            });
            
            document.getElementById('importCarsFile').addEventListener('change', function() {
                importFromExcel('cars', this.files[0]);
            });
            document.getElementById('exportTemplate').addEventListener('click', downloadTemplate);
            document.getElementById('addNewCar').addEventListener('click', showCarModal);
            document.getElementById('sortByLicense').addEventListener('click', () => sortCarsBy('licenseExpiry'));
            document.getElementById('sortByAdLicense').addEventListener('click', () => sortCarsBy('adLicenseExpiry'));
            document.getElementById('sortByMunicipalityLicense').addEventListener('click', () => sortCarsBy('municipalityLicenseExpiry'));
            
            document.getElementById('showDeliveryForm').addEventListener('click', showDeliveryForm);
            document.getElementById('showReceiptForm').addEventListener('click', showReceiptForm);
            document.getElementById('cancelDelivery').addEventListener('click', function() {
                hideDeliveryForm();
                resetDeliveryForm();
                alert('تم إلغاء العملية');
            });
            document.getElementById('saveDelivery').addEventListener('click', saveDelivery);
            document.getElementById('clearScratches').addEventListener('click', clearScratches);
            
            document.getElementById('carNumber').addEventListener('input', function() {
                searchCars(this.value);
            });
            document.getElementById('restaurantName').addEventListener('input', function() {
                searchRestaurants(this.value);
            });
            document.getElementById('carSearch').addEventListener('input', function() {
                filterTable('carsTable', this.value.toLowerCase());
            });
            document.getElementById('deliverySearch').addEventListener('input', function() {
                filterTable('deliveryTable', this.value.toLowerCase());
            });
            document.getElementById('carHistorySearch').addEventListener('input', function() {
                searchCarHistory(this.value);
            });
            
            document.getElementById('printCarsTable').addEventListener('click', () => 
                printTable('carsTable', 'بيانات السيارات'));
            document.getElementById('exportCarsPDF').addEventListener('click', () => 
                exportTableToPDF('carsTable', 'بيانات السيارات'));
            document.getElementById('exportCarsExcel').addEventListener('click', () => 
                exportTableToExcel(carsData, 'بيانات السيارات'));
            
            document.getElementById('printDelivery').addEventListener('click', () => 
                printTable('deliveryTable', 'تسليم السيارات'));
            document.getElementById('exportDeliveryPDF').addEventListener('click', () => 
                exportTableToPDF('deliveryTable', 'تسليم السيارات'));
            document.getElementById('exportDeliveryExcel').addEventListener('click', () => 
                exportTableToExcel(deliveriesData, 'تسليم السيارات'));
            
            document.getElementById('printHistory').addEventListener('click', printCarHistory);
            document.getElementById('exportHistoryPDF').addEventListener('click', exportCarHistoryPDF);
            document.getElementById('exportHistoryExcel').addEventListener('click', exportCarHistoryExcel);
            
            document.getElementById('monthlyReport').addEventListener('click', () => generateReport('monthly'));
            document.getElementById('yearlyReport').addEventListener('click', () => generateReport('yearly'));
            document.getElementById('expiryReport').addEventListener('click', () => generateReport('expiry'));
            document.getElementById('exportReport').addEventListener('click', () => 
                exportTableToExcel(generateReportData(), 'التقارير والإحصائيات'));
            
            document.getElementById('refreshAlerts').addEventListener('click', loadAlertsData);
            document.getElementById('exportAlerts').addEventListener('click', exportAlertsToExcel);
            
            document.getElementById('importRestaurantsFile').addEventListener('change', function() {
                importFromExcel('restaurants', this.files[0]);
            });
            document.getElementById('addRestaurant').addEventListener('click', showRestaurantModal);
            
            document.getElementById('closeCarModal').addEventListener('click', () => 
                document.getElementById('carModal').style.display = 'none');
            document.getElementById('closeRestaurantModal').addEventListener('click', () => 
                document.getElementById('restaurantModal').style.display = 'none');
            
            document.getElementById('saveCar').addEventListener('click', saveCar);
            document.getElementById('cancelCar').addEventListener('click', () => 
                document.getElementById('carModal').style.display = 'none');
            document.getElementById('saveRestaurant').addEventListener('click', saveRestaurant);
            document.getElementById('cancelRestaurant').addEventListener('click', () => 
                document.getElementById('restaurantModal').style.display = 'none');
            
            document.getElementById('viewAlertsBtn').addEventListener('click', function() {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
                
                const alertsTab = Array.from(document.querySelectorAll('.nav-tab')).find(tab => tab.getAttribute('data-target') === 'alerts');
                if (alertsTab) alertsTab.classList.add('active');
                document.getElementById('alerts').classList.add('active');
            });

            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            });
        }

        function switchTab() {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            
            this.classList.add('active');
            const targetId = this.getAttribute('data-target');
            document.getElementById(targetId).classList.add('active');
            
            if (targetId === 'alerts') loadAlertsData();
        }

        function loadAllData() {
            loadCarsData();
            loadDeliveriesData();
            loadRestaurantsData();
            updateStats();
            updateAlertsBar();
        }

        function loadCarsData() {
            const tbody = document.getElementById('carsTableBody');
            tbody.innerHTML = '';
            
            if (carsData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="9" style="text-align: center;">لا توجد سيارات مسجلة</td>`;
                tbody.appendChild(row);
                return;
            }
            
            carsData.forEach(car => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${car.number}</td>
                    <td>${car.type}</td>
                    <td>${car.model}</td>
                    <td>${car.year}</td>
                    <td>${car.licenseExpiry}</td>
                    <td>${car.adLicenseExpiry || '-'}</td>
                    <td>${car.municipalityLicenseExpiry || '-'}</td>
                    <td>${car.status}</td>
                    <td class="no-export">
                        <button class="btn btn-warning edit-car" data-id="${car.id}">تعديل</button>
                        <button class="btn btn-danger delete-car" data-id="${car.id}">حذف</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.querySelectorAll('.edit-car').forEach(btn => {
                btn.addEventListener('click', function() {
                    editCar(parseInt(this.getAttribute('data-id')));
                });
            });

            document.querySelectorAll('.delete-car').forEach(btn => {
                btn.addEventListener('click', function() {
                    deleteCar(parseInt(this.getAttribute('data-id')));
                });
            });
        }

        function loadDeliveriesData() {
            const tbody = document.getElementById('deliveryTableBody');
            tbody.innerHTML = '';
            
            if (deliveriesData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="8" style="text-align: center;">لا توجد عمليات تسليم مسجلة</td>`;
                tbody.appendChild(row);
                return;
            }
            
            deliveriesData.forEach(delivery => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${delivery.carNumber}</td>
                    <td>${delivery.driverName}</td>
                    <td>${delivery.phoneNumber}</td>
                    <td>${delivery.restaurant}</td>
                    <td>${delivery.receiveDate}</td>
                    <td>${delivery.deliveryDate || '-'}</td>
                    <td>${delivery.notes}</td>
                    <td class="no-export">
                        <button class="btn btn-warning edit-delivery" data-id="${delivery.id}">تعديل</button>
                        <button class="btn btn-info print-receipt" data-id="${delivery.id}">طباعة النموذج</button>
                        ${!delivery.deliveryDate ? `<button class="btn btn-primary complete-delivery" data-id="${delivery.id}">إتمام التسليم</button>` : ''}
                        <button class="btn btn-danger delete-delivery" data-id="${delivery.id}">حذف</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.querySelectorAll('.edit-delivery').forEach(btn => {
                btn.addEventListener('click', function() {
                    editDelivery(parseInt(this.getAttribute('data-id')));
                });
            });

            document.querySelectorAll('.print-receipt').forEach(btn => {
                btn.addEventListener('click', function() {
                    printDeliveryReceipt(parseInt(this.getAttribute('data-id')));
                });
            });

            document.querySelectorAll('.complete-delivery').forEach(btn => {
                btn.addEventListener('click', function() {
                    completeDelivery(parseInt(this.getAttribute('data-id')));
                });
            });

            document.querySelectorAll('.delete-delivery').forEach(btn => {
                btn.addEventListener('click', function() {
                    deleteDelivery(parseInt(this.getAttribute('data-id')));
                });
            });
        }

        function loadRestaurantsData() {
            const tbody = document.getElementById('restaurantsTableBody');
            tbody.innerHTML = '';
            
            if (restaurantsData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="2" style="text-align: center;">لا توجد مواقع مسجلة</td>`;
                tbody.appendChild(row);
                return;
            }
            
            restaurantsData.forEach(restaurant => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${restaurant.name}</td>
                    <td class="no-export">
                        <button class="btn btn-warning edit-restaurant" data-id="${restaurant.id}">تعديل</button>
                        <button class="btn btn-danger delete-restaurant" data-id="${restaurant.id}">حذف</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.querySelectorAll('.edit-restaurant').forEach(btn => {
                btn.addEventListener('click', function() {
                    editRestaurant(parseInt(this.getAttribute('data-id')));
                });
            });

            document.querySelectorAll('.delete-restaurant').forEach(btn => {
                btn.addEventListener('click', function() {
                    deleteRestaurant(parseInt(this.getAttribute('data-id')));
                });
            });
        }

        function updateStats() {
            const totalCars = carsData.length;
            const activeCars = carsData.filter(car => car.status === 'نشطة').length;
            const maintenanceCars = carsData.filter(car => car.status === 'تحت الصيانة').length;
            const totalRestaurants = restaurantsData.length;
            
            const today = new Date();
            const nextMonth = new Date();
            nextMonth.setDate(today.getDate() + 30);
            
            const expiringLicenses = carsData.filter(car => {
                const expiryDate = new Date(car.licenseExpiry);
                return expiryDate >= today && expiryDate <= nextMonth;
            }).length;

            const expiringAdLicenses = carsData.filter(car => {
                if (!car.adLicenseExpiry) return false;
                const expiryDate = new Date(car.adLicenseExpiry);
                return expiryDate >= today && expiryDate <= nextMonth;
            }).length;
            
            const activeDeliveries = deliveriesData.filter(d => !d.deliveryDate).length;
            
            document.getElementById('totalCarsCount').textContent = totalCars;
            document.getElementById('activeCarsCount').textContent = activeCars;
            document.getElementById('maintenanceCarsCount').textContent = maintenanceCars;
            document.getElementById('expiringLicensesCount').textContent = expiringLicenses;
            document.getElementById('expiringAdLicensesCount').textContent = expiringAdLicenses;
            document.getElementById('activeDeliveriesCount').textContent = activeDeliveries;
            document.getElementById('totalRestaurantsCount').textContent = totalRestaurants;
        }

        function updateAlertsBar() {
            const today = new Date();
            const nextMonth = new Date();
            nextMonth.setDate(today.getDate() + 30);
            
            const expiringLicenses = carsData.filter(car => {
                const expiryDate = new Date(car.licenseExpiry);
                return expiryDate >= today && expiryDate <= nextMonth;
            }).length;

            const expiringAdLicenses = carsData.filter(car => {
                if (!car.adLicenseExpiry) return false;
                const expiryDate = new Date(car.adLicenseExpiry);
                return expiryDate >= today && expiryDate <= nextMonth;
            }).length;
            
            const expiredLicenses = carsData.filter(car => {
                const expiryDate = new Date(car.licenseExpiry);
                return expiryDate < today;
            }).length;

            const expiredAdLicenses = carsData.filter(car => {
                if (!car.adLicenseExpiry) return false;
                const expiryDate = new Date(car.adLicenseExpiry);
                return expiryDate < today;
            }).length;
            
            const alertsBar = document.getElementById('alertsBar');
            const licenseAlertCount = document.getElementById('licenseAlertCount');
            const adLicenseAlertCount = document.getElementById('adLicenseAlertCount');
            const expiredLicenseAlertCount = document.getElementById('expiredLicenseAlertCount');
            const expiredAdLicenseAlertCount = document.getElementById('expiredAdLicenseAlertCount');
            
            if (expiringLicenses > 0 || expiringAdLicenses > 0 || expiredLicenses > 0 || expiredAdLicenses > 0) {
                alertsBar.style.display = 'flex';
                licenseAlertCount.textContent = expiringLicenses;
                adLicenseAlertCount.textContent = expiringAdLicenses;
                expiredLicenseAlertCount.textContent = expiredLicenses;
                expiredAdLicenseAlertCount.textContent = expiredAdLicenses;
            } else {
                alertsBar.style.display = 'none';
            }
        }

        function checkLicenseExpiry() {
            const today = new Date();
            const nextMonth = new Date();
            nextMonth.setDate(today.getDate() + 30);
            
            const expiringCars = carsData.filter(car => {
                const expiryDate = new Date(car.licenseExpiry);
                return expiryDate >= today && expiryDate <= nextMonth;
            });
            
            const alertElement = document.getElementById('licenseAlert');
            const alertMessage = document.getElementById('alertMessage');
            
            if (expiringCars.length > 0) {
                const carNumbers = expiringCars.map(car => car.number).join(', ');
                alertMessage.textContent = `هناك ${expiringCars.length} سيارات على وشك انتهاء الترخيص خلال الشهر القادم: ${carNumbers}`;
                alertElement.style.display = 'block';
            } else {
                alertElement.style.display = 'none';
            }
        }

        function showDeliveryForm() {
            resetDeliveryForm();
            document.getElementById('deliveryForm').style.display = 'block';
            document.getElementById('receiptForm').style.display = 'none';
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('receiveDate').value = today;
            editingDeliveryId = null;
        }

        function showReceiptForm() {
            document.getElementById('receiptForm').style.display = 'block';
            document.getElementById('deliveryForm').style.display = 'none';
            
            document.getElementById('receiptCarNumber').textContent = '';
            document.getElementById('receiptRestaurant').textContent = '';
            document.getElementById('receiptDriverName').textContent = '';
            document.getElementById('receiptPhoneNumber').textContent = '';
            document.getElementById('receiptReceiveDate').textContent = '';
            document.getElementById('receiptNotes').textContent = '';
            
            const receiptCarSketch = document.getElementById('receiptCarSketch');
            const oldScratches = receiptCarSketch.querySelectorAll('.scratch-point');
            oldScratches.forEach(scratch => scratch.remove());
        }

        function hideDeliveryForm() {
            document.getElementById('deliveryForm').style.display = 'none';
            document.getElementById('receiptForm').style.display = 'none';
            
            const carSearchResults = document.getElementById('carSearchResults');
            const restaurantSearchResults = document.getElementById('restaurantSearchResults');
            if (carSearchResults) carSearchResults.style.display = 'none';
            if (restaurantSearchResults) restaurantSearchResults.style.display = 'none';
            
            const carNumberError = document.getElementById('carNumberError');
            const restaurantNameError = document.getElementById('restaurantNameError');
            if (carNumberError) carNumberError.style.display = 'none';
            if (restaurantNameError) restaurantNameError.style.display = 'none';
            
            editingDeliveryId = null;
            scratches = [];
            updateScratchesList();
        }

        function resetDeliveryForm() {
            const fields = ['carNumber', 'restaurantName', 'driverName', 'phoneNumber', 'receiveDate', 'deliveryDate', 'notes'];
            
            fields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    if (element.type === 'date') {
                        if (fieldId === 'receiveDate') {
                            element.valueAsDate = new Date();
                        } else {
                            element.value = '';
                        }
                    } else {
                        element.value = '';
                    }
                }
            });
            
            scratches = [];
            updateScratchesList();
            document.getElementById('carNumberError').style.display = 'none';
            document.getElementById('restaurantNameError').style.display = 'none';
            document.getElementById('carSearchResults').style.display = 'none';
            document.getElementById('restaurantSearchResults').style.display = 'none';
        }

        function saveDelivery() {
            const carNumber = document.getElementById('carNumber').value.trim();
            const restaurantName = document.getElementById('restaurantName').value.trim();
            const driverName = document.getElementById('driverName').value.trim();
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            const receiveDate = document.getElementById('receiveDate').value;
            const deliveryDate = document.getElementById('deliveryDate').value;
            const notes = document.getElementById('notes').value;
            
            if (!carNumber || !restaurantName || !driverName) {
                alert('يرجى ملء الحقول الإجبارية (رقم السيارة، اسم الموقع، اسم السائق)');
                return;
            }
            
            const car = carsData.find(c => c.number === carNumber);
            if (!car) {
                document.getElementById('carNumberError').style.display = 'block';
                alert('السيارة غير مسجلة في النظام');
                return;
            }
            document.getElementById('carNumberError').style.display = 'none';
            
            if (car.status !== 'نشطة') {
                let statusMessage = car.status === 'تحت الصيانة' ? 'تحت الصيانة' : 'غير نشطة';
                alert(`لا يمكن تسليم السيارة ${carNumber} لأنها ${statusMessage}`);
                return;
            }
            
            const restaurantExists = restaurantsData.some(restaurant => restaurant.name === restaurantName);
            if (!restaurantExists) {
                document.getElementById('restaurantNameError').style.display = 'block';
                alert('الموقع غير مسجل في النظام');
                return;
            }
            document.getElementById('restaurantNameError').style.display = 'none';
            
            if (!editingDeliveryId) {
                const activeDelivery = deliveriesData.find(d => d.carNumber === carNumber && !d.deliveryDate);
                if (activeDelivery) {
                    alert(`لا يمكن تسليم السيارة ${carNumber} لأنها مسلمة حالياً للسائق ${activeDelivery.driverName}`);
                    return;
                }
            }
            
            const deliveryData = {
                carNumber: carNumber,
                driverName: driverName,
                phoneNumber: phoneNumber,
                restaurant: restaurantName,
                receiveDate: receiveDate || new Date().toISOString().split('T')[0],
                deliveryDate: deliveryDate,
                notes: notes,
                scratches: [...scratches]
            };
            
            if (editingDeliveryId) {
                const deliveryIndex = deliveriesData.findIndex(d => d.id === editingDeliveryId);
                if (deliveryIndex !== -1) {
                    deliveriesData[deliveryIndex] = {
                        ...deliveriesData[deliveryIndex],
                        ...deliveryData
                    };
                } else {
                    alert('لم يتم العثور على التسليم للتعديل');
                    return;
                }
            } else {
                const newDelivery = {
                    id: deliveriesData.length > 0 ? Math.max(...deliveriesData.map(d => d.id)) + 1 : 1,
                    ...deliveryData
                };
                
                deliveriesData.push(newDelivery);
            }
            
            saveAllData();
            loadDeliveriesData();
            updateStats();
            hideDeliveryForm();
            alert('تم حفظ بيانات التسليم بنجاح');
        }

        function printDeliveryReceipt(deliveryId) {
            const delivery = deliveriesData.find(d => d.id === deliveryId);
            if (!delivery) {
                alert('لم يتم العثور على بيانات التسليم');
                return;
            }
            
            const receiptHTML = `
                <div class="receipt-container">
                    <div class="receipt-header">
                        <img src="https://i.postimg.cc/NM2zJWZD/NAIF-LOGO.jpg" alt="شعار الشركة" class="receipt-logo">
                        <h1 class="receipt-title">نموذج استلام سيارة</h1>
                        <div class="receipt-company">شركة نايف للأغذية</div>
                    </div>
                    
                    <div class="receipt-details">
                        <h3>بيانات السيارة المستلمة</h3>
                        <table class="data-table">
                            <tbody>
                                <tr>
                                    <th>رقم السيارة</th>
                                    <td>${delivery.carNumber}</td>
                                </tr>
                                <tr>
                                    <th>اسم الموقع</th>
                                    <td>${delivery.restaurant}</td>
                                </tr>
                                <tr>
                                    <th>اسم السائق</th>
                                    <td>${delivery.driverName}</td>
                                </tr>
                                <tr>
                                    <th>رقم الموبايل</th>
                                    <td>${delivery.phoneNumber}</td>
                                </tr>
                                <tr>
                                    <th>تاريخ الاستلام</th>
                                    <td>${delivery.receiveDate}</td>
                                </tr>
                                <tr>
                                    <th>ملاحظات</th>
                                    <td>${delivery.notes}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="car-sketch-container">
                        <h3>خريطة الخدوش بالسيارة</h3>
                        <div class="car-sketch" id="receiptCarSketch">
                            <div class="car-body"></div>
                            <div class="car-front"></div>
                            <div class="car-rear"></div>
                            <div class="car-window"></div>
                            <div class="car-wheel wheel-front"></div>
                            <div class="car-wheel wheel-rear"></div>
                            <div class="car-direction front-direction">أمام</div>
                            <div class="car-direction rear-direction">خلف</div>
                        </div>
                    </div>
                    
                    <div class="signature-container">
                        <h3>توقيع السائق باستلام السيارة</h3>
                        <div class="signature-box"></div>
                    </div>
                </div>
            `;
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = receiptHTML;
            
            if (delivery.scratches && delivery.scratches.length > 0) {
                const receiptCarSketch = tempDiv.querySelector('#receiptCarSketch');
                delivery.scratches.forEach(scratch => {
                    const scratchPoint = document.createElement('div');
                    scratchPoint.className = 'scratch-point';
                    scratchPoint.style.left = `${scratch.x - 5}px`;
                    scratchPoint.style.top = `${scratch.y - 5}px`;
                    receiptCarSketch.appendChild(scratchPoint);
                });
            }
            
            const opt = {
                margin: 10,
                filename: `نموذج_استلام_${delivery.carNumber}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(tempDiv).save();
        }

        function editDelivery(id) {
            const delivery = deliveriesData.find(d => d.id === id);
            if (delivery) {
                editingDeliveryId = id;
                document.getElementById('carNumber').value = delivery.carNumber;
                document.getElementById('driverName').value = delivery.driverName;
                document.getElementById('phoneNumber').value = delivery.phoneNumber;
                document.getElementById('restaurantName').value = delivery.restaurant;
                document.getElementById('receiveDate').value = delivery.receiveDate;
                document.getElementById('deliveryDate').value = delivery.deliveryDate || '';
                document.getElementById('notes').value = delivery.notes;
                
                if (delivery.scratches) {
                    scratches = [...delivery.scratches];
                    updateScratchesList();
                    renderScratches();
                }
                
                document.getElementById('deliveryForm').style.display = 'block';
            }
        }

        function completeDelivery(id) {
            const delivery = deliveriesData.find(d => d.id === id);
            if (delivery) {
                delivery.deliveryDate = new Date().toISOString().split('T')[0];
                saveAllData();
                loadDeliveriesData();
                updateStats();
                alert('تم إتمام التسليم بنجاح');
            }
        }

        function deleteDelivery(id) {
            if (confirm('هل أنت متأكد من حذف هذا التسليم؟')) {
                deliveriesData = deliveriesData.filter(d => d.id !== id);
                saveAllData();
                loadDeliveriesData();
                updateStats();
                alert('تم حذف التسليم بنجاح');
            }
        }

        function showCarModal() {
            editingCarId = null;
            document.getElementById('carModal').style.display = 'block';
            document.getElementById('carModal').querySelector('h2').textContent = 'إضافة سيارة جديدة';
            document.getElementById('newCarNumber').value = '';
            document.getElementById('newCarType').value = '';
            document.getElementById('newCarModel').value = '';
            document.getElementById('newCarYear').value = '';
            document.getElementById('newLicenseExpiry').value = new Date().toISOString().split('T')[0];
            document.getElementById('newAdLicenseExpiry').value = '';
            document.getElementById('newMunicipalityLicenseExpiry').value = '';
            document.getElementById('newCarStatus').value = 'نشطة';
        }

        function saveCar() {
            const number = document.getElementById('newCarNumber').value.trim();
            const type = document.getElementById('newCarType').value.trim();
            const model = document.getElementById('newCarModel').value.trim();
            const year = document.getElementById('newCarYear').value;
            const licenseExpiry = document.getElementById('newLicenseExpiry').value;
            const adLicenseExpiry = document.getElementById('newAdLicenseExpiry').value;
            const municipalityLicenseExpiry = document.getElementById('newMunicipalityLicenseExpiry').value;
            const status = document.getElementById('newCarStatus').value;
            
            if (!number || !type || !model || !year || !licenseExpiry) {
                alert('يرجى ملء جميع الحقول الإجبارية');
                return;
            }
            
            const currentYear = new Date().getFullYear();
            if (year < 1900 || year > currentYear + 1) {
                alert('سنة الصنع غير صحيحة');
                return;
            }
            
            if (!isValidDate(licenseExpiry)) {
                alert('تاريخ انتهاء دفتر السيارة غير صحيح');
                return;
            }
            
            if (adLicenseExpiry && !isValidDate(adLicenseExpiry)) {
                alert('تاريخ انتهاء ترخيص الإعلان غير صحيح');
                return;
            }
            
            if (municipalityLicenseExpiry && !isValidDate(municipalityLicenseExpiry)) {
                alert('تاريخ انتهاء ترخيص البلدية غير صحيح');
                return;
            }
            
            if (editingCarId) {
                const existingCar = carsData.find(c => c.number === number && c.id !== editingCarId);
                if (existingCar) {
                    alert(`رقم السيارة ${number} مستخدم من قبل سيارة أخرى`);
                    return;
                }
            } else {
                const existingCar = carsData.find(c => c.number === number);
                if (existingCar) {
                    alert(`رقم السيارة ${number} موجود مسبقاً في النظام`);
                    return;
                }
            }
            
            if (editingCarId) {
                const carIndex = carsData.findIndex(c => c.id === editingCarId);
                if (carIndex !== -1) {
                    carsData[carIndex] = {
                        ...carsData[carIndex],
                        number: number,
                        type: type,
                        model: model,
                        year: parseInt(year),
                        licenseExpiry: licenseExpiry,
                        adLicenseExpiry: adLicenseExpiry || null,
                        municipalityLicenseExpiry: municipalityLicenseExpiry || null,
                        status: status
                    };
                } else {
                    alert('لم يتم العثور على السيارة للتعديل');
                    return;
                }
            } else {
                const newCar = {
                    id: carsData.length > 0 ? Math.max(...carsData.map(c => c.id)) + 1 : 1,
                    number: number,
                    type: type,
                    model: model,
                    year: parseInt(year),
                    licenseExpiry: licenseExpiry,
                    adLicenseExpiry: adLicenseExpiry || null,
                    municipalityLicenseExpiry: municipalityLicenseExpiry || null,
                    status: status
                };
                
                carsData.push(newCar);
            }
            
            saveAllData();
            loadCarsData();
            updateStats();
            updateAlertsBar();
            checkLicenseExpiry();
            document.getElementById('carModal').style.display = 'none';
            alert('تم حفظ بيانات السيارة بنجاح');
        }

        function isValidDate(dateString) {
            const regex = /^\d{4}-\d{2}-\d{2}$/;
            if (!dateString.match(regex)) return false;
            
            const date = new Date(dateString);
            const timestamp = date.getTime();
            
            if (typeof timestamp !== 'number' || Number.isNaN(timestamp)) {
                return false;
            }
            
            return date.toISOString().split('T')[0] === dateString;
        }

        function editCar(id) {
            const car = carsData.find(c => c.id === id);
            if (car) {
                editingCarId = id;
                document.getElementById('carModal').style.display = 'block';
                document.getElementById('carModal').querySelector('h2').textContent = 'تعديل بيانات السيارة';
                document.getElementById('newCarNumber').value = car.number;
                document.getElementById('newCarType').value = car.type;
                document.getElementById('newCarModel').value = car.model;
                document.getElementById('newCarYear').value = car.year;
                document.getElementById('newLicenseExpiry').value = car.licenseExpiry;
                document.getElementById('newAdLicenseExpiry').value = car.adLicenseExpiry || '';
                document.getElementById('newMunicipalityLicenseExpiry').value = car.municipalityLicenseExpiry || '';
                document.getElementById('newCarStatus').value = car.status;
            }
        }

        function deleteCar(id) {
            if (confirm('هل أنت متأكد من حذف هذه السيارة؟')) {
                carsData = carsData.filter(c => c.id !== id);
                saveAllData();
                loadCarsData();
                updateStats();
                updateAlertsBar();
                checkLicenseExpiry();
                alert('تم حذف السيارة بنجاح');
            }
        }

        function showRestaurantModal() {
            editingRestaurantId = null;
            document.getElementById('restaurantModal').style.display = 'block';
            document.getElementById('restaurantModal').querySelector('h2').textContent = 'إضافة موقع جديد';
            document.getElementById('newRestaurantName').value = '';
        }

        function saveRestaurant() {
            const name = document.getElementById('newRestaurantName').value;

            if (!name) {
                alert('يرجى ملء اسم الموقع');
                return;
            }
            
            if (editingRestaurantId) {
                const restaurantIndex = restaurantsData.findIndex(r => r.id === editingRestaurantId);
                if (restaurantIndex !== -1) {
                    restaurantsData[restaurantIndex] = {
                        ...restaurantsData[restaurantIndex],
                        name: name
                    };
                }
            } else {
                const newRestaurant = {
                    id: restaurantsData.length > 0 ? Math.max(...restaurantsData.map(r => r.id)) + 1 : 1,
                    name: name
                };
                
                restaurantsData.push(newRestaurant);
            }
            
            saveAllData();
            loadRestaurantsData();
            updateStats();
            document.getElementById('restaurantModal').style.display = 'none';
            alert('تم حفظ بيانات الموقع بنجاح');
        }

        function editRestaurant(id) {
            const restaurant = restaurantsData.find(r => r.id === id);
            if (restaurant) {
                editingRestaurantId = id;
                document.getElementById('restaurantModal').style.display = 'block';
                document.getElementById('restaurantModal').querySelector('h2').textContent = 'تعديل بيانات الموقع';
                document.getElementById('newRestaurantName').value = restaurant.name;
            }
        }

        function deleteRestaurant(id) {
            if (confirm('هل أنت متأكد من حذف هذا الموقع؟')) {
                restaurantsData = restaurantsData.filter(r => r.id !== id);
                saveAllData();
                loadRestaurantsData();
                updateStats();
                alert('تم حذف الموقع بنجاح');
            }
        }

        function initializeCarSketch() {
            const carSketch = document.getElementById('carSketch');
            if (carSketch) {
                carSketch.addEventListener('click', function(e) {
                    const rect = this.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    let location = '';
                    if (x < rect.width * 0.2) {
                        location = 'المقدمة اليسرى';
                    } else if (x < rect.width * 0.4) {
                        location = 'المقدمة';
                    } else if (x < rect.width * 0.6) {
                        location = 'الوسط';
                    } else if (x < rect.width * 0.8) {
                        location = 'الخلف';
                    } else {
                        location = 'المقدمة اليمنى';
                    }
                    
                    addScratch(x, y, location);
                });
            }
        }

        function addScratch(x, y, location) {
            const scratch = {
                id: scratches.length + 1,
                x: x,
                y: y,
                location: location
            };
            
            scratches.push(scratch);
            updateScratchesList();
            renderScratches();
        }

        function updateScratchesList() {
            const scratchList = document.getElementById('scratchList');
            scratchList.innerHTML = '';
            
            if (scratches.length === 0) {
                scratchList.innerHTML = `<p>لا توجد خدوش مسجلة</p>`;
                return;
            }
            
            scratches.forEach(scratch => {
                const scratchItem = document.createElement('div');
                scratchItem.className = 'scratch-item';
                scratchItem.innerHTML = `
                    <span class="scratch-location">${scratch.location}</span>
                    <button class="remove-scratch" data-id="${scratch.id}">حذف</button>
                `;
                scratchList.appendChild(scratchItem);
            });
            
            document.querySelectorAll('.remove-scratch').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    removeScratch(id);
                });
            });
        }

        function renderScratches() {
            const carSketch = document.getElementById('carSketch');
            const oldScratches = carSketch.querySelectorAll('.scratch-point');
            oldScratches.forEach(scratch => scratch.remove());
            
            scratches.forEach(scratch => {
                const scratchPoint = document.createElement('div');
                scratchPoint.className = 'scratch-point';
                scratchPoint.style.left = `${scratch.x - 5}px`;
                scratchPoint.style.top = `${scratch.y - 5}px`;
                scratchPoint.setAttribute('data-id', scratch.id);
                carSketch.appendChild(scratchPoint);
            });
        }

        function removeScratch(id) {
            scratches = scratches.filter(scratch => scratch.id !== id);
            updateScratchesList();
            renderScratches();
        }

        function clearScratches() {
            scratches = [];
            updateScratchesList();
            renderScratches();
        }

        function searchCars(query) {
            const resultsContainer = document.getElementById('carSearchResults');
            resultsContainer.innerHTML = '';
            
            if (query.length < 1) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            const filteredCars = carsData.filter(car => 
                car.number.toLowerCase().includes(query.toLowerCase())
            );
            
            if (filteredCars.length > 0) {
                filteredCars.forEach(car => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.textContent = car.number;
                    item.addEventListener('click', function() {
                        document.getElementById('carNumber').value = car.number;
                        resultsContainer.style.display = 'none';
                        document.getElementById('carNumberError').style.display = 'none';
                    });
                    resultsContainer.appendChild(item);
                });
                resultsContainer.style.display = 'block';
            } else {
                resultsContainer.style.display = 'none';
            }
        }

        function searchCarHistory(query) {
            const resultsContainer = document.getElementById('carHistorySearchResults');
            resultsContainer.innerHTML = '';
            
            if (query.length < 1) {
                resultsContainer.style.display = 'none';
                const carDetails = document.getElementById('carDetails');
                carDetails.innerHTML = '';
                return;
            }
            
            const filteredCars = carsData.filter(car => 
                car.number.toLowerCase().includes(query.toLowerCase()) ||
                car.type.toLowerCase().includes(query.toLowerCase()) ||
                car.model.toLowerCase().includes(query.toLowerCase())
            );
            
            if (filteredCars.length > 0) {
                filteredCars.forEach(car => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.textContent = `${car.number} - ${car.type} - ${car.model}`;
                    item.addEventListener('click', function() {
                        document.getElementById('carHistorySearch').value = car.number;
                        resultsContainer.style.display = 'none';
                        displayCarDetails(car);
                    });
                    resultsContainer.appendChild(item);
                });
                resultsContainer.style.display = 'block';
            } else {
                resultsContainer.style.display = 'none';
                const carDetails = document.getElementById('carDetails');
                carDetails.innerHTML = `<p>لا توجد سيارة تطابق معايير البحث</p>`;
            }
        }

        function displayCarDetails(car) {
            const carDeliveries = deliveriesData.filter(d => d.carNumber === car.number);
            
            let deliveriesHtml = '';
            if (carDeliveries.length > 0) {
                deliveriesHtml = `
                    <h4>حركات السيارة</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>اسم السائق</th>
                                <th>رقم الموبايل</th>
                                <th>اسم الموقع</th>
                                <th>تاريخ الاستلام</th>
                                <th>تاريخ التسليم</th>
                                <th>ملاحظات</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${carDeliveries.map(d => `
                                <tr>
                                    <td>${d.driverName}</td>
                                    <td>${d.phoneNumber}</td>
                                    <td>${d.restaurant}</td>
                                    <td>${d.receiveDate}</td>
                                    <td>${d.deliveryDate || '-'}</td>
                                    <td>${d.notes}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                deliveriesHtml = `<p>لا توجد حركات مسجلة لهذه السيارة</p>`;
            }
            
            const carDetails = document.getElementById('carDetails');
            carDetails.innerHTML = `
                <h3>تفاصيل السيارة: ${car.number}</h3>
                <div class="car-info">
                    <p><strong>نوع السيارة:</strong> ${car.type}</p>
                    <p><strong>موديل السيارة:</strong> ${car.model}</p>
                    <p><strong>سنة الصنع:</strong> ${car.year}</p>
                    <p><strong>تاريخ انتهاء السيارة:</strong> ${car.licenseExpiry}</p>
                    <p><strong>تاريخ انتهاء ترخيص الإعلان:</strong> ${car.adLicenseExpiry || '-'}</p>
                    <p><strong>تاريخ انتهاء ترخيص البلدية:</strong> ${car.municipalityLicenseExpiry || '-'}</p>
                    <p><strong>الحالة:</strong> ${car.status}</p>
                </div>
                ${deliveriesHtml}
            `;
        }

        function searchRestaurants(query) {
            const resultsContainer = document.getElementById('restaurantSearchResults');
            resultsContainer.innerHTML = '';
            
            if (query.length < 1) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            const filteredRestaurants = restaurantsData.filter(restaurant => 
                restaurant.name.toLowerCase().includes(query.toLowerCase())
            );
            
            if (filteredRestaurants.length > 0) {
                filteredRestaurants.forEach(restaurant => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.textContent = restaurant.name;
                    item.addEventListener('click', function() {
                        document.getElementById('restaurantName').value = restaurant.name;
                        resultsContainer.style.display = 'none';
                        document.getElementById('restaurantNameError').style.display = 'none';
                    });
                    resultsContainer.appendChild(item);
                });
                resultsContainer.style.display = 'block';
            } else {
                resultsContainer.style.display = 'none';
            }
        }

        function filterTable(tableId, query) {
            const table = document.getElementById(tableId);
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                let found = false;
                
                for (let j = 0; j < cells.length; j++) {
                    const cellText = cells[j].textContent.toLowerCase();
                    if (cellText.includes(query)) {
                        found = true;
                        break;
                    }
                }
                
                rows[i].style.display = found ? '' : 'none';
            }
        }

        function sortCarsBy(field) {
            const isSameField = currentSort.field === field;
            
            if (isSameField) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.order = 'asc';
            }
            
            carsData.sort((a, b) => {
                let aValue = a[field];
                let bValue = b[field];
                
                if (field.includes('Expiry')) {
                    aValue = aValue ? new Date(aValue) : new Date(0);
                    bValue = bValue ? new Date(bValue) : new Date(0);
                }
                
                if (aValue < bValue) return currentSort.order === 'asc' ? -1 : 1;
                if (aValue > bValue) return currentSort.order === 'asc' ? 1 : -1;
                return 0;
            });
            
            loadCarsData();
        }

        function printTable(tableId, title) {
            const table = document.getElementById(tableId);
            const newWin = window.open('', 'Print-Window');
            
            const tempTable = table.cloneNode(true);
            const noExportCells = tempTable.querySelectorAll('.no-export');
            noExportCells.forEach(cell => {
                if (cell.tagName === 'TH' || cell.tagName === 'TD') {
                    cell.style.display = 'none';
                }
            });
            
            newWin.document.open();
            newWin.document.write(`
                <html>
                <head>
                    <title>Print</title>
                    <style>
                        body { font-family: Arial, sans-serif; direction: rtl; }
                        h1 { text-align: center; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #000; padding: 8px; text-align: right; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    ${tempTable.outerHTML}
                </body>
                </html>
            `);
            newWin.document.close();
            newWin.print();
            newWin.close();
        }

        function printCarHistory() {
            const carDetails = document.getElementById('carDetails');
            if (carDetails.innerHTML.trim() !== '') {
                printElement(carDetails, 'كشف السيارة');
            } else {
                alert('لا توجد بيانات للطباعة');
            }
        }

        function printElement(element, title) {
            const newWin = window.open('', 'Print-Window');
            newWin.document.open();
            newWin.document.write(`
                <html>
                <head>
                    <title>Print</title>
                    <style>
                        body { font-family: Arial, sans-serif; direction: rtl; }
                        h1 { text-align: center; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { border: 1px solid #000; padding: 8px; text-align: right; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    ${element.innerHTML}
                </body>
                </html>
            `);
            newWin.document.close();
            newWin.print();
            newWin.close();
        }

        function exportTableToPDF(tableId, title) {
            const table = document.getElementById(tableId);
            const tempTable = table.cloneNode(true);
            const noExportCells = tempTable.querySelectorAll('.no-export');
            noExportCells.forEach(cell => {
                if (cell.tagName === 'TH' || cell.tagName === 'TD') {
                    cell.style.display = 'none';
                }
            });
            
            const opt = {
                margin: 10,
                filename: `${title}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = `<h2 style="text-align: center; margin-bottom: 20px;">${title}</h2>${tempTable.outerHTML}`;
            
            html2pdf().set(opt).from(tempDiv).save();
        }

        // دالة تصدير كشف السيارة إلى PDF باستخدام القالب المخفي (الطريقة المرفقة)
        async function exportCarHistoryPDF() {
            const carDetails = document.getElementById('carDetails');
            if (carDetails.innerHTML.trim() === '') {
                alert('لا توجد بيانات للتصدير');
                return;
            }

            // استخراج بيانات السيارة المعروضة
            const carNumberElem = carDetails.querySelector('h3');
            if (!carNumberElem) return;
            
            const carNumber = carNumberElem.textContent.replace('تفاصيل السيارة: ', '');
            const car = carsData.find(c => c.number === carNumber);
            if (!car) return;

            // تجهيز قالب PDF
            const template = document.getElementById('pdf-template');
            const originalDisplay = template.style.display;
            const originalPosition = template.style.position;
            const originalLeft = template.style.left;
            const originalTop = template.style.top;

            template.style.display = 'block';
            template.style.position = 'fixed';
            template.style.left = '0';
            template.style.top = '0';
            template.style.zIndex = '10000';

            // تعبئة البيانات
            document.getElementById('pdf-car-number').textContent = car.number;
            document.getElementById('pdf-print-date').textContent = new Date().toLocaleDateString('ar-KW');

            const carInfoDiv = document.getElementById('pdf-car-info');
            carInfoDiv.innerHTML = `
                <strong>نوع السيارة:</strong> ${car.type} | 
                <strong>موديل:</strong> ${car.model} | 
                <strong>سنة الصنع:</strong> ${car.year} | 
                <strong>انتهاء الترخيص:</strong> ${car.licenseExpiry} | 
                <strong>انتهاء الإعلان:</strong> ${car.adLicenseExpiry || '-'} | 
                <strong>انتهاء البلدية:</strong> ${car.municipalityLicenseExpiry || '-'} | 
                <strong>الحالة:</strong> ${car.status}
            `;

            const carDeliveries = deliveriesData.filter(d => d.carNumber === car.number);
            const tableBody = document.getElementById('pdf-table-body');
            tableBody.innerHTML = '';

            if (carDeliveries.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="6" style="text-align: center;">لا توجد حركات مسجلة لهذه السيارة</td>`;
                tableBody.appendChild(row);
            } else {
                carDeliveries.forEach(d => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${d.receiveDate}</td>
                        <td>${d.deliveryDate || '-'}</td>
                        <td>${d.driverName}</td>
                        <td>${d.phoneNumber || '-'}</td>
                        <td>${d.restaurant}</td>
                        <td>${d.notes || '-'}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            try {
                const canvas = await html2canvas(template, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#FFFFFF',
                    width: 794,
                    height: 1123,
                    windowWidth: 794,
                    windowHeight: 1123
                });

                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                const pdf = new window.jspdf.jsPDF('p', 'pt', 'a4');
                const imgWidth = pdf.internal.pageSize.getWidth();
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                pdf.save(`كشف_بيانات_${car.number}.pdf`);

            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('حدث خطأ أثناء إنشاء ملف PDF');
            } finally {
                template.style.display = originalDisplay;
                template.style.position = originalPosition;
                template.style.left = originalLeft;
                template.style.top = originalTop;
                template.style.zIndex = '-1000';
            }
        }

        function exportTableToExcel(data, title) {
            try {
                if (!data || (Array.isArray(data) && data.length === 0)) {
                    alert('لا توجد بيانات للتصدير');
                    return;
                }

                const wb = XLSX.utils.book_new();
                let ws;

                if (Array.isArray(data) && data.length > 0 && typeof data[0] === 'object') {
                    ws = XLSX.utils.json_to_sheet(data);
                } else {
                    ws = XLSX.utils.aoa_to_sheet(data);
                }

                if (!ws['!cols']) ws['!cols'] = [];
                const range = XLSX.utils.decode_range(ws['!ref']);
                const numCols = range.e.c - range.s.c + 1;
                
                for (let i = 0; i < numCols; i++) {
                    ws['!cols'][i] = { width: 15 };
                }

                for (let col = range.s.c; col <= range.e.c; col++) {
                    const headerCell = XLSX.utils.encode_cell({ r: range.s.r, c: col });
                    if (!ws[headerCell].s) ws[headerCell].s = {};
                    ws[headerCell].s = {
                        fill: { fgColor: { rgb: "4472C4" } },
                        font: { bold: true, color: { rgb: "FFFFFF" } },
                        alignment: { horizontal: "center", vertical: "center" }
                    };
                }

                for (let row = range.s.r + 1; row <= range.e.r; row++) {
                    for (let col = range.s.c; col <= range.e.c; col++) {
                        const cell = XLSX.utils.encode_cell({ r: row, c: col });
                        if (!ws[cell].s) ws[cell].s = {};
                        ws[cell].s = {
                            fill: { fgColor: { rgb: row % 2 === 0 ? "E6E6E6" : "FFFFFF" } },
                            alignment: { horizontal: "right", vertical: "center" }
                        };
                    }
                }

                for (let row = range.s.r; row <= range.e.r; row++) {
                    for (let col = range.s.c; col <= range.e.c; col++) {
                        const cell = XLSX.utils.encode_cell({ r: row, c: col });
                        if (!ws[cell].s) ws[cell].s = {};
                        if (!ws[cell].s.border) ws[cell].s.border = {};
                        ws[cell].s.border = {
                            top: { style: "thin", color: { rgb: "000000" } },
                            left: { style: "thin", color: { rgb: "000000" } },
                            bottom: { style: "thin", color: { rgb: "000000" } },
                            right: { style: "thin", color: { rgb: "000000" } }
                        };
                    }
                }

                if (!ws['!views']) ws['!views'] = [];
                ws['!views'].push({ rightToLeft: true });

                XLSX.utils.book_append_sheet(wb, ws, "Data");
                XLSX.writeFile(wb, `${title}.xlsx`);
                
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('حدث خطأ أثناء التصدير');
            }
        }

        function exportCarHistoryExcel() {
            const carDetails = document.getElementById('carDetails');
            if (carDetails.innerHTML.trim() !== '') {
                const tables = carDetails.getElementsByTagName('table');
                if (tables.length > 0) {
                    const data = tableToJSON(tables[0]);
                    exportTableToExcel(data, 'كشف السيارة');
                }
            } else {
                alert('لا توجد بيانات للتصدير');
            }
        }

        function tableToJSON(table) {
            const data = [];
            const headers = [];
            
            const headerCells = table.querySelectorAll('thead th');
            headerCells.forEach(cell => {
                headers.push(cell.textContent);
            });
            
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const rowData = {};
                const cells = row.querySelectorAll('td');
                cells.forEach((cell, index) => {
                    if (headers[index]) {
                        rowData[headers[index]] = cell.textContent;
                    }
                });
                data.push(rowData);
            });
            
            return data;
        }

        function loadAlertsData() {
            const tbody = document.getElementById('expiringLicensesTableBody');
            tbody.innerHTML = '';
            
            const today = new Date();
            const nextMonth = new Date();
            nextMonth.setDate(today.getDate() + 30);
            
            const expiringLicenses = carsData.filter(car => {
                const expiryDate = new Date(car.licenseExpiry);
                return expiryDate >= today && expiryDate <= nextMonth;
            });

            const expiringAdLicenses = carsData.filter(car => {
                if (!car.adLicenseExpiry) return false;
                const expiryDate = new Date(car.adLicenseExpiry);
                return expiryDate >= today && expiryDate <= nextMonth;
            });
            
            const expiredLicenses = carsData.filter(car => {
                const expiryDate = new Date(car.licenseExpiry);
                return expiryDate < today;
            });

            const expiredAdLicenses = carsData.filter(car => {
                if (!car.adLicenseExpiry) return false;
                const expiryDate = new Date(car.adLicenseExpiry);
                return expiryDate < today;
            });
            
            if (expiringLicenses.length === 0 && expiringAdLicenses.length === 0 && 
                expiredLicenses.length === 0 && expiredAdLicenses.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="4" style="text-align: center;">لا توجد تراخيص منتهية</td>`;
                tbody.appendChild(row);
                return;
            }
            
            expiringLicenses.forEach(car => {
                const expiryDate = new Date(car.licenseExpiry);
                const daysRemaining = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                
                let daysClass = 'days-normal';
                if (daysRemaining <= 7) {
                    daysClass = 'days-critical';
                } else if (daysRemaining <= 15) {
                    daysClass = 'days-warning';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${car.number}</td>
                    <td>ترخيص السيارة</td>
                    <td>${car.licenseExpiry}</td>
                    <td><span class="days-remaining ${daysClass}">${daysRemaining} يوم</span></td>
                `;
                tbody.appendChild(row);
            });
            
            expiringAdLicenses.forEach(car => {
                const expiryDate = new Date(car.adLicenseExpiry);
                const daysRemaining = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                
                let daysClass = 'days-normal';
                if (daysRemaining <= 7) {
                    daysClass = 'days-critical';
                } else if (daysRemaining <= 15) {
                    daysClass = 'days-warning';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${car.number}</td>
                    <td>ترخيص الإعلان</td>
                    <td>${car.adLicenseExpiry}</td>
                    <td><span class="days-remaining ${daysClass}">${daysRemaining} يوم</span></td>
                `;
                tbody.appendChild(row);
            });
            
            expiredLicenses.forEach(car => {
                const expiryDate = new Date(car.licenseExpiry);
                const daysRemaining = Math.floor((today - expiryDate) / (1000 * 60 * 60 * 24));
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${car.number}</td>
                    <td>ترخيص السيارة</td>
                    <td>${car.licenseExpiry}</td>
                    <td><span class="days-remaining days-expired">-${daysRemaining} يوم</span></td>
                `;
                tbody.appendChild(row);
            });
            
            expiredAdLicenses.forEach(car => {
                const expiryDate = new Date(car.adLicenseExpiry);
                const daysRemaining = Math.floor((today - expiryDate) / (1000 * 60 * 60 * 24));
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${car.number}</td>
                    <td>ترخيص الإعلان</td>
                    <td>${car.adLicenseExpiry}</td>
                    <td><span class="days-remaining days-expired">-${daysRemaining} يوم</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function exportAlertsToExcel() {
            const today = new Date();
            const nextMonth = new Date();
            nextMonth.setDate(today.getDate() + 30);
            
            const expiringLicenses = carsData.filter(car => {
                const expiryDate = new Date(car.licenseExpiry);
                return expiryDate >= today && expiryDate <= nextMonth;
            });

            const expiringAdLicenses = carsData.filter(car => {
                if (!car.adLicenseExpiry) return false;
                const expiryDate = new Date(car.adLicenseExpiry);
                return expiryDate >= today && expiryDate <= nextMonth;
            });
            
            const expiredLicenses = carsData.filter(car => {
                const expiryDate = new Date(car.licenseExpiry);
                return expiryDate < today;
            });

            const expiredAdLicenses = carsData.filter(car => {
                if (!car.adLicenseExpiry) return false;
                const expiryDate = new Date(car.adLicenseExpiry);
                return expiryDate < today;
            });
            
            const alertsData = [];
            
            expiringLicenses.forEach(car => {
                const expiryDate = new Date(car.licenseExpiry);
                const daysRemaining = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                
                alertsData.push({
                    'رقم السيارة': car.number,
                    'نوع الترخيص': 'ترخيص السيارة',
                    'تاريخ الانتهاء': car.licenseExpiry,
                    'الأيام المتبقية': daysRemaining
                });
            });
            
            expiringAdLicenses.forEach(car => {
                const expiryDate = new Date(car.adLicenseExpiry);
                const daysRemaining = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                
                alertsData.push({
                    'رقم السيارة': car.number,
                    'نوع الترخيص': 'ترخيص الإعلان',
                    'تاريخ الانتهاء': car.adLicenseExpiry,
                    'الأيام المتبقية': daysRemaining
                });
            });
            
            expiredLicenses.forEach(car => {
                const expiryDate = new Date(car.licenseExpiry);
                const daysRemaining = Math.floor((today - expiryDate) / (1000 * 60 * 60 * 24));
                
                alertsData.push({
                    'رقم السيارة': car.number,
                    'نوع الترخيص': 'ترخيص السيارة (منتهي)',
                    'تاريخ الانتهاء': car.licenseExpiry,
                    'الأيام المتبقية': -daysRemaining
                });
            });
            
            expiredAdLicenses.forEach(car => {
                const expiryDate = new Date(car.adLicenseExpiry);
                const daysRemaining = Math.floor((today - expiryDate) / (1000 * 60 * 60 * 24));
                
                alertsData.push({
                    'رقم السيارة': car.number,
                    'نوع الترخيص': 'ترخيص الإعلان (منتهي)',
                    'تاريخ الانتهاء': car.adLicenseExpiry,
                    'الأيام المتبقية': -daysRemaining
                });
            });
            
            if (alertsData.length === 0) {
                alert('لا توجد تنبيهات للتصدير');
                return;
            }
            
            exportTableToExcel(alertsData, 'التنبيهات');
        }

        function generateReport(type) {
            let reportData = [];
            let title = '';
            let description = '';
            
            if (type === 'monthly') {
                title = 'تقرير شهري';
                description = 'التسليمات خلال الشهر الحالي';
                reportData = deliveriesData.filter(d => {
                    const receiveDate = new Date(d.receiveDate);
                    const currentMonth = new Date().getMonth();
                    const currentYear = new Date().getFullYear();
                    return receiveDate.getMonth() === currentMonth && receiveDate.getFullYear() === currentYear;
                });
            } else if (type === 'yearly') {
                title = 'تقرير سنوي';
                description = 'التسليمات خلال السنة الحالية';
                reportData = deliveriesData.filter(d => {
                    const receiveDate = new Date(d.receiveDate);
                    const currentYear = new Date().getFullYear();
                    return receiveDate.getFullYear() === currentYear;
                });
            } else if (type === 'expiry') {
                title = 'تقرير المواعيد المنتهية';
                description = 'التراخيص المنتهية خلال 30 يوم';
                const today = new Date();
                const nextMonth = new Date();
                nextMonth.setDate(today.getDate() + 30);
                
                reportData = carsData.filter(car => {
                    const expiryDate = new Date(car.licenseExpiry);
                    return expiryDate >= today && expiryDate <= nextMonth;
                });
            }
            
            const reportResults = document.getElementById('reportResults');
            
            if (reportData.length === 0) {
                reportResults.innerHTML = `
                    <h3>${title}</h3>
                    <p>${description}</p>
                    <p>لا توجد بيانات لعرضها</p>
                `;
                return;
            }
            
            reportResults.innerHTML = `
                <h3>${title}</h3>
                <p>${description}</p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>رقم السيارة</th>
                            <th>نوع السيارة</th>
                            <th>موديل السيارة</th>
                            <th>${type === 'expiry' ? 'تاريخ انتهاء الترخيص' : 'تاريخ الاستلام'}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${reportData.map(item => `
                            <tr>
                                <td>${type === 'expiry' ? item.number : item.carNumber}</td>
                                <td>${type === 'expiry' ? item.type : ''}</td>
                                <td>${type === 'expiry' ? item.model : ''}</td>
                                <td>${type === 'expiry' ? item.licenseExpiry : item.receiveDate}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function generateReportData() {
            return [
                ['إجمالي السيارات', carsData.length],
                ['السيارات النشطة', carsData.filter(car => car.status === 'نشطة').length],
                ['السيارات تحت الصيانة', carsData.filter(car => car.status === 'تحت الصيانة').length],
                ['إجمالي المواقع', restaurantsData.length],
                ['عمليات التسليم النشطة', deliveriesData.filter(d => !d.deliveryDate).length]
            ];
        }

        function importFromExcel(type, file) {
            if (!file) {
                alert('يرجى اختيار ملف');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { 
                    type: 'array',
                    cellDates: true,
                    cellText: false
                });
                
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                    raw: false,
                    dateNF: 'yyyy-mm-dd'
                });
                
                if (type === 'cars') {
                    jsonData.forEach(item => {
                        let licenseExpiry = item['تاريخ انتهاء الترخيص'] || item['License Expiry'];
                        let adLicenseExpiry = item['تاريخ انتهاء ترخيص الإعلان'] || item['Ad License Expiry'];
                        let municipalityLicenseExpiry = item['تاريخ انتهاء ترخيص البلدية'] || item['Municipality License Expiry'];
                        
                        licenseExpiry = formatExcelDate(licenseExpiry);
                        adLicenseExpiry = formatExcelDate(adLicenseExpiry);
                        municipalityLicenseExpiry = formatExcelDate(municipalityLicenseExpiry);
                        
                        const newCar = {
                            id: carsData.length > 0 ? Math.max(...carsData.map(c => c.id)) + 1 : 1,
                            number: item['رقم السيارة'] || item['Car Number'],
                            type: item['نوع السيارة'] || item['Car Type'],
                            model: item['موديل السيارة'] || item['Car Model'],
                            year: parseInt(item['سنة الصنع'] || item['Manufacturing Year']),
                            licenseExpiry: licenseExpiry,
                            adLicenseExpiry: adLicenseExpiry || null,
                            municipalityLicenseExpiry: municipalityLicenseExpiry || null,
                            status: item['الحالة'] || item['Status'] || 'نشطة'
                        };
                        
                        carsData.push(newCar);
                    });
                    
                    saveAllData();
                    loadCarsData();
                    updateStats();
                    updateAlertsBar();
                    checkLicenseExpiry();
                    alert('تم استيراد بيانات السيارات بنجاح');
                } else if (type === 'restaurants') {
                    jsonData.forEach(item => {
                        const newRestaurant = {
                            id: restaurantsData.length > 0 ? Math.max(...restaurantsData.map(r => r.id)) + 1 : 1,
                            name: item['اسم الموقع'] || item['Location Name']
                        };
                        
                        restaurantsData.push(newRestaurant);
                    });
                    
                    saveAllData();
                    loadRestaurantsData();
                    updateStats();
                    alert('تم استيراد بيانات المواقع بنجاح');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function formatExcelDate(dateValue) {
            if (!dateValue) return '';
            
            if (dateValue instanceof Date) {
                return dateValue.toISOString().split('T')[0];
            }
            
            if (typeof dateValue === 'number') {
                const excelEpoch = new Date(1899, 11, 30);
                const jsDate = new Date(excelEpoch.getTime() + dateValue * 24 * 60 * 60 * 1000);
                return jsDate.toISOString().split('T')[0];
            }
            
            if (typeof dateValue === 'string') {
                const dateFormats = [
                    /(\d{4})-(\d{2})-(\d{2})/,
                    /(\d{2})\/(\d{2})\/(\d{4})/,
                    /(\d{2})-(\d{2})-(\d{4})/,
                    /(\d{4})\/(\d{2})\/(\d{2})/
                ];
                
                for (let format of dateFormats) {
                    const match = dateValue.match(format);
                    if (match) {
                        if (format === dateFormats[0]) {
                            return dateValue;
                        } else if (format === dateFormats[1]) {
                            return `${match[3]}-${match[1].padStart(2, '0')}-${match[2].padStart(2, '0')}`;
                        } else if (format === dateFormats[2]) {
                            return `${match[3]}-${match[2].padStart(2, '0')}-${match[1].padStart(2, '0')}`;
                        } else if (format === dateFormats[3]) {
                            return `${match[1]}-${match[2].padStart(2, '0')}-${match[3].padStart(2, '0')}`;
                        }
                    }
                }
                
                return dateValue;
            }
            
            return '';
        }

        function downloadTemplate() {
            const wb = XLSX.utils.book_new();
            
            const carsData = [
                ['رقم السيارة', 'نوع السيارة', 'موديل السيارة', 'سنة الصنع', 'تاريخ انتهاء الترخيص', 'تاريخ انتهاء ترخيص الإعلان', 'تاريخ انتهاء ترخيص البلدية', 'الحالة'],
                ['16/8826', 'تويوتا', '1994', 1994, '2026-03-10', '2026-06-17', '2026-03-10', 'نشطة'],
                ['8/5056', 'تويوتا', '1996', 1996, '2026-08-10', '', '', 'نشطة']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(carsData);
            
            if (!ws['!cols']) ws['!cols'] = [];
            ws['!cols'][0] = { width: 15 };
            ws['!cols'][1] = { width: 15 };
            ws['!cols'][2] = { width: 15 };
            ws['!cols'][3] = { width: 12 };
            ws['!cols'][4] = { width: 20 };
            ws['!cols'][5] = { width: 25 };
            ws['!cols'][6] = { width: 25 };
            ws['!cols'][7] = { width: 15 };
            
            for (let R = 1; R <= 2; R++) {
                const licenseCell = XLSX.utils.encode_cell({r: R, c: 4});
                if (!ws[licenseCell]) ws[licenseCell] = {};
                ws[licenseCell].t = 'd';
                ws[licenseCell].z = 'yyyy-mm-dd';
                
                const adLicenseCell = XLSX.utils.encode_cell({r: R, c: 5});
                if (!ws[adLicenseCell]) ws[adLicenseCell] = {};
                ws[adLicenseCell].t = 'd';
                ws[adLicenseCell].z = 'yyyy-mm-dd';
                
                const municipalityCell = XLSX.utils.encode_cell({r: R, c: 6});
                if (!ws[municipalityCell]) ws[municipalityCell] = {};
                ws[municipalityCell].t = 'd';
                ws[municipalityCell].z = 'yyyy-mm-dd';
            }
            
            const instructions = [
                [''],
                ['تعليمات التعبئة:'],
                ['1. يجب أن تكون التواريخ بصيغة YYYY-MM-DD (مثال: 2026-12-31)'],
                ['2. سنة الصنع يجب أن تكون رقماً صحيحاً'],
                ['3. الحالة يجب أن تكون واحدة من: نشطة، تحت الصيانة، غير نشطة'],
                ['4. لا تقم بتغيير تنسيق التواريخ في Excel'],
                ['5. احفظ الملف بصيغة .xlsx']
            ];
            
            const instructionRange = XLSX.utils.decode_range(ws['!ref']);
            const startRow = instructionRange.e.r + 2;
            
            instructions.forEach((instruction, index) => {
                instruction.forEach((cell, colIndex) => {
                    const cellAddress = XLSX.utils.encode_cell({r: startRow + index, c: colIndex});
                    if (!ws[cellAddress]) ws[cellAddress] = {};
                    ws[cellAddress].v = cell;
                    
                    if (index === 0) {
                        ws[cellAddress].s = { font: { bold: true, color: { rgb: "FF0000" } } };
                    }
                });
            });
            
            XLSX.utils.book_append_sheet(wb, ws, "Cars Template");
            XLSX.writeFile(wb, "Cars_Template.xlsx");
        }

        function showSyncNotification(message, type) {
            let notification = document.getElementById('syncNotification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'syncNotification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 8px;
                    color: white;
                    font-weight: bold;
                    z-index: 10000;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    max-width: 300px;
                    text-align: center;
                `;
                document.body.appendChild(notification);
            }
            
            if (type === 'success') {
                notification.style.backgroundColor = '#2ecc71';
            } else if (type === 'error') {
                notification.style.backgroundColor = '#e74c3c';
            } else {
                notification.style.backgroundColor = '#3498db';
            }
            
            notification.textContent = message;
            notification.style.display = 'block';
            notification.style.opacity = '1';
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>
